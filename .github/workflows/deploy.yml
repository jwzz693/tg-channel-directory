name: Build & Deploy TG Channel Directory

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * *"

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
      - name: Install
        run: npm ci
      - name: Sync Data
        run: npm run sync
        env:
          DATA_REPO_URL: ${{ secrets.DATA_REPO_URL }}
          DATA_REPO_GITHUB_OWNER: ${{ secrets.DATA_REPO_GITHUB_OWNER }}
          DATA_REPO_GITHUB_NAME: ${{ secrets.DATA_REPO_GITHUB_NAME }}
          DATA_REPO_FILE_PATH: ${{ secrets.DATA_REPO_FILE_PATH }}
          DATA_REPO_BRANCH: ${{ secrets.DATA_REPO_BRANCH }}
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
      - name: Build
        run: npm run build
        env:
          SITE_URL: ${{ secrets.SITE_URL }}
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

  deploy_pages:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4

  deploy_vercel:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install
        run: npm ci
      - name: Build
        run: npm run build
        env:
          SITE_URL: ${{ secrets.SITE_URL }}
      - name: Deploy to Vercel
        run: npx vercel deploy dist --prod --token=${{ secrets.VERCEL_TOKEN }} --yes
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

  deploy_netlify:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install
        run: npm ci
      - name: Build
        run: npm run build
        env:
          SITE_URL: ${{ secrets.SITE_URL }}
      - name: Deploy to Netlify
        run: npx netlify-cli deploy --dir=dist --prod --site=${{ secrets.NETLIFY_SITE_ID }} --auth=${{ secrets.NETLIFY_AUTH_TOKEN }}

  deploy_cloudflare:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install Wrangler
        run: npm i -g wrangler
      - name: Deploy to Cloudflare Pages
        run: wrangler pages deploy dist --project-name=${{ secrets.CF_PAGES_PROJECT }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  submit_search:
    needs: [deploy_pages]
    runs-on: ubuntu-latest
    steps:
      - name: Ping Google sitemap
        if: ${{ secrets.SITE_URL }}
        run: |
          curl -sS "https://www.google.com/ping?sitemap=${{ secrets.SITE_URL }}/sitemap.xml" || exit 1
      - name: Ping Bing sitemap
        if: ${{ secrets.SITE_URL }}
        run: |
          curl -sS "https://www.bing.com/ping?sitemap=${{ secrets.SITE_URL }}/sitemap.xml" || exit 1
      - name: Submit to Baidu
        if: ${{ secrets.BAIDU_TOKEN && secrets.BAIDU_SITE && secrets.SITE_URL }}
        run: |
          URLS=$(curl -sS "${{ secrets.SITE_URL }}/urls.txt")
          echo "$URLS" | curl -sS -H 'Content-Type:text/plain' --data-binary @- "http://data.zz.baidu.com/urls?site=${{ secrets.BAIDU_SITE }}&token=${{ secrets.BAIDU_TOKEN }}"
